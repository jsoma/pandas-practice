<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pandas Mastery - Learn pandas the smart way</title>
    
    <!-- React & Babel CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Prism.js for code highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    
    <!-- JSZip for file compression -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- Custom styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        code, pre {
            font-family: 'JetBrains Mono', monospace;
        }
        
        .code-editor {
            font-family: 'JetBrains Mono', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .shimmer {
            background: linear-gradient(to right, #f0f0f0 0%, #f8f8f8 50%, #f0f0f0 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        
        // Pandas equivalency rules
        const PANDAS_EQUIVALENCIES = [
            {
                pattern: ['nlargest', 'n', 'col'],
                equivalent: [
                    ['sort_values', 'col', { ascending: false }],
                    ['head', 'n']
                ]
            },
            {
                pattern: ['value_counts'],
                equivalent: [
                    ['groupby', 'col'],
                    ['size']
                ]
            },
            {
                pattern: ['nunique'],
                equivalent: [
                    ['unique'],
                    ['len']
                ]
            }
        ];
        
        // SRS Algorithm
        class SRSAlgorithm {
            constructor() {
                this.intervals = [1, 3, 7, 14, 30, 90]; // Days
                this.easinessFactor = 2.5;
            }
            
            calculateNextReview(quality, repetitions, easiness, interval) {
                // SM-2 algorithm
                let newEasiness = easiness;
                let newRepetitions = repetitions;
                let newInterval = interval;
                
                if (quality < 3) {
                    newRepetitions = 0;
                    newInterval = 1;
                } else {
                    newEasiness = easiness + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
                    newEasiness = Math.max(1.3, newEasiness);
                    
                    if (repetitions === 0) {
                        newInterval = 1;
                    } else if (repetitions === 1) {
                        newInterval = 6;
                    } else {
                        newInterval = Math.round(interval * newEasiness);
                    }
                    newRepetitions = repetitions + 1;
                }
                
                return {
                    interval: newInterval,
                    repetitions: newRepetitions,
                    easiness: newEasiness,
                    nextReview: Date.now() + (newInterval * 24 * 60 * 60 * 1000)
                };
            }
        }
        
        // Components
        const Header = ({ progress, performanceHistory, onReset, onExport }) => {
            const percentage = Math.round((progress.mastered / progress.total) * 100) || 0;
            
            // Calculate performance metrics for different windows
            const getPerformanceMetrics = (lastN) => {
                const recent = performanceHistory.slice(-lastN);
                if (recent.length === 0) return null;
                const correct = recent.filter(h => h.correct).length;
                const accuracy = Math.round((correct / recent.length) * 100);
                return { attempted: recent.length, correct, accuracy };
            };
            
            const metrics = {
                last5: getPerformanceMetrics(5),
                last10: getPerformanceMetrics(10),
                last25: getPerformanceMetrics(25),
                last50: getPerformanceMetrics(50)
            };
            
            return (
                <header className="bg-white shadow-sm border-b border-gray-200">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="flex items-center justify-between h-16">
                            <div className="flex items-center">
                                <h1 className="text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                                    Pandas Mastery
                                </h1>
                                <span className="ml-3 text-sm text-gray-500">
                                    Learn pandas through spaced repetition
                                </span>
                            </div>
                            
                            <div className="flex items-center space-x-6">
                                <div className="flex items-center space-x-3">
                                    <svg className="w-10 h-10 progress-ring" viewBox="0 0 36 36">
                                        <path
                                            d="M18 2.0845
                                            a 15.9155 15.9155 0 0 1 0 31.831
                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                            fill="none"
                                            stroke="#e5e7eb"
                                            strokeWidth="3"
                                        />
                                        <path
                                            d="M18 2.0845
                                            a 15.9155 15.9155 0 0 1 0 31.831
                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                            fill="none"
                                            stroke="url(#gradient)"
                                            strokeWidth="3"
                                            strokeDasharray={`${percentage}, 100`}
                                        />
                                        <defs>
                                            <linearGradient id="gradient">
                                                <stop offset="0%" stopColor="#9333ea" />
                                                <stop offset="100%" stopColor="#ec4899" />
                                            </linearGradient>
                                        </defs>
                                    </svg>
                                    <div>
                                        <div className="text-2xl font-semibold">{percentage}%</div>
                                        <div className="text-xs text-gray-500">
                                            {progress.mastered}/{progress.total} mastered
                                        </div>
                                    </div>
                                </div>
                                
                                <button
                                    onClick={onExport}
                                    className="px-4 py-2 text-sm bg-purple-600 text-white hover:bg-purple-700 rounded-lg transition-colors"
                                >
                                    Export Results
                                </button>
                                <button
                                    onClick={onReset}
                                    className="px-4 py-2 text-sm text-gray-600 hover:text-gray-900 transition-colors"
                                >
                                    Reset Progress
                                </button>
                            </div>
                        </div>
                        
                        {/* Performance Dashboard */}
                        {performanceHistory.length > 0 && (
                            <div className="py-3 border-t border-gray-100">
                                <div className="flex items-center justify-between">
                                    <div className="text-sm text-gray-600">Recent Performance:</div>
                                    <div className="flex space-x-6">
                                        {[5, 10, 25, 50].map(n => {
                                            const metric = metrics[`last${n}`];
                                            if (!metric || metric.attempted === 0) return null;
                                            return (
                                                <div key={n} className="text-center">
                                                    <div className="text-xs text-gray-500">Last {n}</div>
                                                    <div className={`text-sm font-medium ${
                                                        metric.accuracy >= 80 ? 'text-green-600' :
                                                        metric.accuracy >= 60 ? 'text-yellow-600' :
                                                        'text-red-600'
                                                    }`}>
                                                        {metric.accuracy}%
                                                    </div>
                                                    <div className="text-xs text-gray-400">
                                                        ({metric.correct}/{metric.attempted})
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </header>
            );
        };
        
        const DataPreview = ({ data, columns, descriptions }) => {
            if (!data || data.length === 0) return null;
            
            // Always treat first row as headers for this app
            const displayColumns = data[0] || [];
            const displayData = data.slice(1);
            
            return (
                <div className="mb-6">
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200 text-sm">
                            <thead className="bg-gray-50">
                                <tr>
                                    {displayColumns.map((col, i) => (
                                        <th key={i} className="px-3 py-2 text-left">
                                            <div className="text-xs font-medium text-gray-700 uppercase tracking-wider">
                                                {col}
                                            </div>
                                            {descriptions && descriptions[col] && (
                                                <div className="text-xs font-normal text-gray-500 normal-case mt-1">
                                                    {descriptions[col]}
                                                </div>
                                            )}
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {displayData.slice(0, 5).map((row, i) => (
                                    <tr key={i}>
                                        {Array.isArray(row) ? row.map((cell, j) => (
                                            <td key={j} className="px-3 py-2 whitespace-nowrap text-gray-900">
                                                {cell !== null && cell !== undefined ? String(cell) : ''}
                                            </td>
                                        )) : (
                                            <td className="px-3 py-2 whitespace-nowrap text-gray-900">
                                                {String(row)}
                                            </td>
                                        )}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };
        
        const MultipleChoiceQuestion = ({ question, onAnswer, onTrack }) => {
            const [selected, setSelected] = useState(null);
            const [showFeedback, setShowFeedback] = useState(false);
            const [showHint, setShowHint] = useState(false);
            const [startTime] = useState(Date.now());
            
            // Generate choices based on the question
            const choices = useMemo(() => {
                const correct = question.canonicalAnswer.code;
                const distractors = [];
                
                // Generate distractors based on the correct answer
                if (correct.includes('value_counts()')) {
                    distractors.push(
                        correct.replace('value_counts()', 'count()'),
                        correct.replace('value_counts()', 'size()'),
                        correct.replace('value_counts()', 'unique()')
                    );
                } else if (correct.includes('groupby')) {
                    distractors.push(
                        correct.replace('groupby', 'sort_values'),
                        correct.replace('.sum()', '.mean()'),
                        correct.replace('.mean()', '.sum()')
                    );
                } else if (correct.includes('nlargest')) {
                    distractors.push(
                        correct.replace('nlargest', 'nsmallest'),
                        correct.replace('nlargest', 'head'),
                        correct.replace('nlargest', 'tail')
                    );
                } else if (correct.includes('nunique()')) {
                    distractors.push(
                        correct.replace('nunique()', 'count()'),
                        correct.replace('nunique()', 'size()'),
                        correct.replace('nunique()', 'unique()')
                    );
                } else if (correct.includes('sort_values')) {
                    distractors.push(
                        correct.replace('ascending=False', 'ascending=True'),
                        correct.replace('sort_values', 'sort_index'),
                        correct.replace('head(', 'tail(')
                    );
                } else {
                    // Generic distractors
                    distractors.push(
                        correct + '.head()',
                        correct.replace('].', '].unique().'),
                        correct.includes('()') ? correct.replace('()', '().sum()') : correct + '.count()'
                    );
                }
                
                // Filter out duplicates and ensure we have at least 3 distractors
                const uniqueDistractors = [...new Set(distractors.filter(d => d !== correct))];
                while (uniqueDistractors.length < 3) {
                    uniqueDistractors.push(correct + `.head(${uniqueDistractors.length + 1})`);
                }
                
                return [...uniqueDistractors.slice(0, 3), correct].sort(() => Math.random() - 0.5);
            }, [question]);
            
            const handleSubmit = () => {
                if (selected === null) return;
                
                setShowFeedback(true);
                const isCorrect = choices[selected] === question.canonicalAnswer.code;
                
                // Track the attempt
                const timeSpent = Math.round((Date.now() - startTime) / 1000);
                onTrack({
                    question_id: question.id,
                    question_text: question.question,
                    answer_selected: choices[selected],
                    correct_answer: question.canonicalAnswer.code,
                    is_correct: isCorrect,
                    hint_shown: showHint,
                    time_spent: timeSpent,
                    question_type: 'multiple_choice',
                    skipped: false
                });
            };
            
            const handleSkip = () => {
                setShowFeedback(true);
                // When skipping, we don't select any answer
                setSelected(null);
                
                // Track the skip
                const timeSpent = Math.round((Date.now() - startTime) / 1000);
                onTrack({
                    question_id: question.id,
                    question_text: question.question,
                    answer_selected: null,
                    correct_answer: question.canonicalAnswer.code,
                    is_correct: false,
                    hint_shown: showHint,
                    time_spent: timeSpent,
                    question_type: 'multiple_choice',
                    skipped: true
                });
            };
            
            const handleNext = () => {
                const isCorrect = selected !== null && choices[selected] === question.canonicalAnswer.code;
                // If skipped, give minimal points (1), otherwise normal scoring
                onAnswer(selected === null ? 1 : (isCorrect ? 5 : 2));
                setSelected(null);
                setShowFeedback(false);
            };
            
            // Apply syntax highlighting
            useEffect(() => {
                if (typeof Prism !== 'undefined') {
                    Prism.highlightAll();
                }
            }, [choices]);
            
            return (
                <div className="space-y-4">
                    {question.hint && !showFeedback && (
                        <div className="relative">
                            <div className={`p-4 bg-white border border-gray-200 rounded-lg transition-all duration-300 ${
                                showHint ? '' : 'select-none'
                            }`}>
                                <p className={`text-sm text-gray-700 transition-all duration-300 ${
                                    showHint ? '' : 'blur-sm'
                                }`}>
                                    <strong>Hint:</strong> {question.hint}
                                </p>
                            </div>
                            {!showHint && (
                                <div className="absolute inset-0 flex items-center justify-center">
                                    <button
                                        onClick={() => setShowHint(true)}
                                        className="px-4 py-2 text-sm text-purple-600 hover:text-purple-800 bg-white hover:bg-purple-50 rounded-lg transition-all font-medium shadow-sm border border-purple-200"
                                    >
                                        Show Hint
                                    </button>
                                </div>
                            )}
                            {showHint && (
                                <button
                                    onClick={() => setShowHint(false)}
                                    className="absolute top-2 right-2 text-xs text-gray-500 hover:text-gray-700"
                                >
                                    Hide
                                </button>
                            )}
                        </div>
                    )}
                    
                    <div className="space-y-3">
                        {choices.map((choice, i) => {
                            const isCorrect = choice === question.canonicalAnswer.code;
                            const isSelected = selected === i;
                            const showAsIncorrect = showFeedback && !isCorrect;
                            const showAsCorrect = showFeedback && isCorrect;
                            const showAsWrong = showFeedback && isSelected && !isCorrect;
                            
                            return (
                                <label
                                    key={i}
                                    className={`flex items-start space-x-3 transition-all duration-300 ${
                                        showFeedback ? 'cursor-not-allowed' : 'cursor-pointer'
                                    } ${
                                        showAsIncorrect ? 'opacity-30' : ''
                                    }`}
                                >
                                    <div className="flex items-center h-full pt-3">
                                        <input
                                            type="radio"
                                            name="answer"
                                            value={i}
                                            checked={selected === i}
                                            onChange={() => !showFeedback && setSelected(i)}
                                            disabled={showFeedback}
                                            className="h-5 w-5 text-purple-600 focus:ring-purple-500 focus:ring-2 cursor-pointer"
                                        />
                                    </div>
                                    <div className={`flex-1 transition-all duration-300 ${
                                        showAsCorrect
                                            ? ''
                                            : ''
                                    } ${
                                        showAsWrong
                                            ? ''
                                            : ''
                                    }`}>
                                        <pre className={`rounded p-3 overflow-auto transition-all duration-300 ${
                                            showAsCorrect 
                                                ? 'bg-green-50 border-2 border-green-500' 
                                                : showAsWrong
                                                ? 'bg-red-50 border-2 border-red-500'
                                                : 'bg-gray-100'
                                        }`} style={{ whiteSpace: 'pre-wrap', wordBreak: 'break-word' }}>
                                            <code className="language-python text-sm" style={{ whiteSpace: 'pre-wrap', wordBreak: 'break-word' }}>{choice}</code>
                                        </pre>
                                        {showAsCorrect && (
                                            <div className="mt-2 text-green-700 font-medium text-sm">
                                                ✓ Correct answer
                                            </div>
                                        )}
                                        {showAsWrong && (
                                            <div className="mt-2 text-red-700 font-medium text-sm">
                                                ✗ Incorrect
                                            </div>
                                        )}
                                    </div>
                                </label>
                            );
                        })}
                    </div>
                    
                    {showFeedback && question.explanation && (
                        <div className="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <h4 className="text-sm font-semibold text-blue-900 mb-2">Why this answer?</h4>
                            <p className="text-sm text-blue-800">{question.explanation}</p>
                        </div>
                    )}
                    
                    {!showFeedback ? (
                        <div className="flex space-x-3">
                            <button
                                onClick={handleSubmit}
                                disabled={selected === null}
                                className="flex-1 py-3 px-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-medium rounded-lg hover:from-purple-700 hover:to-pink-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                            >
                                Submit Answer
                            </button>
                            <button
                                onClick={handleSkip}
                                className="py-3 px-4 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-all text-sm font-medium"
                            >
                                Show Answer
                            </button>
                        </div>
                    ) : (
                        <button
                            onClick={handleNext}
                            className="w-full py-3 px-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-medium rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all"
                        >
                            Next Question →
                        </button>
                    )}
                </div>
            );
        };
        
        const CodeEntryQuestion = ({ question, onAnswer, onTrack, guided = false }) => {
            const [code, setCode] = useState('');
            const [showHint, setShowHint] = useState(false);
            const [feedback, setFeedback] = useState(null);
            const [startTime] = useState(Date.now());
            const [showExplanation, setShowExplanation] = useState(false);
            
            const checkAnswer = () => {
                // Simple equivalency checking
                const normalized = code.trim().replace(/\s+/g, ' ');
                const canonical = question.canonicalAnswer.code.trim().replace(/\s+/g, ' ');
                
                let isCorrect = false;
                let quality = 2;
                
                // Exact match
                if (normalized === canonical) {
                    setFeedback({ correct: true, message: 'Perfect!' });
                    isCorrect = true;
                    quality = 5;
                } else {
                    // Check for common equivalencies
                    // This is simplified - in production would use proper AST parsing
                    const hasValueCounts = normalized.includes('value_counts()');
                    const hasGroupbySize = normalized.includes('groupby') && normalized.includes('size()');
                    
                    if ((hasValueCounts && canonical.includes('value_counts')) ||
                        (hasGroupbySize && canonical.includes('value_counts'))) {
                        setFeedback({ correct: true, message: 'Great! That\'s an equivalent solution.' });
                        isCorrect = true;
                        quality = 4;
                    } else {
                        setFeedback({ correct: false, message: 'Not quite. Try again!' });
                    }
                }
                
                // Track the attempt
                const timeSpent = Math.round((Date.now() - startTime) / 1000);
                onTrack({
                    question_id: question.id,
                    question_text: question.question,
                    answer_selected: code,
                    correct_answer: question.canonicalAnswer.code,
                    is_correct: isCorrect,
                    hint_shown: showHint,
                    time_spent: timeSpent,
                    question_type: guided ? 'guided_code' : 'free_code',
                    skipped: false
                });
                
                if (isCorrect) {
                    setShowExplanation(true);
                    setTimeout(() => onAnswer(quality), 3000); // Increased to allow time to read explanation
                } else {
                    setTimeout(() => setFeedback(null), 3000);
                }
            };
            
            return (
                <div className="space-y-4">
                    {guided && (
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p className="text-sm text-blue-800">
                                <strong>Structure hint:</strong> df[_____].______()
                            </p>
                        </div>
                    )}
                    
                    <div className="relative">
                        <textarea
                            value={code}
                            onChange={(e) => setCode(e.target.value)}
                            placeholder="Enter your pandas code here..."
                            className="w-full h-32 p-4 font-mono text-sm bg-gray-900 text-gray-100 rounded-lg resize-none focus:ring-2 focus:ring-purple-500 focus:outline-none"
                        />
                        {feedback && (
                            <div className={`absolute -bottom-8 left-0 text-sm font-medium ${
                                feedback.correct ? 'text-green-600' : 'text-red-600'
                            }`}>
                                {feedback.message}
                            </div>
                        )}
                    </div>
                    
                    <div className="flex space-x-3">
                        <button
                            onClick={() => setShowHint(!showHint)}
                            className="flex-1 py-2 px-4 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                        >
                            {showHint ? 'Hide' : 'Show'} Hint
                        </button>
                        
                        <button
                            onClick={checkAnswer}
                            disabled={!code.trim()}
                            className="flex-1 py-2 px-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-medium rounded-lg hover:from-purple-700 hover:to-pink-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                        >
                            Check Answer
                        </button>
                    </div>
                    
                    {showHint && (
                        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 fade-in">
                            <p className="text-sm text-yellow-800">{question.hint}</p>
                        </div>
                    )}
                    
                    {showExplanation && question.explanation && (
                        <div className="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg fade-in">
                            <h4 className="text-sm font-semibold text-blue-900 mb-2">Why this answer?</h4>
                            <p className="text-sm text-blue-800">{question.explanation}</p>
                        </div>
                    )}
                </div>
            );
        };
        
        const QuestionCard = ({ question, mode, onAnswer, onTrack }) => {
            return (
                <div className="max-w-4xl mx-auto">
                    <div className="bg-white rounded-xl shadow-lg p-8 card-hover">
                        <div className="mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <span className="text-sm font-medium text-gray-500">
                                    Dataset: {question.dataset}
                                </span>
                                <div className="flex items-center space-x-2">
                                    <span className={`px-3 py-1 text-xs font-medium rounded-full ${
                                        question.difficulty === 1 ? 'bg-green-100 text-green-800' :
                                        question.difficulty === 2 ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-red-100 text-red-800'
                                    }`}>
                                        {question.difficulty === 1 ? 'Easy' :
                                         question.difficulty === 2 ? 'Medium' :
                                         'Hard'}
                                    </span>
                                </div>
                            </div>
                            
                            <h2 className="text-2xl font-semibold text-gray-900 mb-2">
                                {question.question}
                            </h2>
                            
                            {question.context && (
                                <p className="text-gray-600">{question.context}</p>
                            )}
                        </div>
                        
                        {question.dataPreview && (
                            <DataPreview 
                                data={question.dataPreview} 
                                columns={question.dataColumns || (question.dataPreview[0] || [])}
                                descriptions={question.columnDescriptions}
                            />
                        )}
                        
                        <div className="mt-6">
                            {mode === 'multiple_choice' && (
                                <MultipleChoiceQuestion question={question} onAnswer={onAnswer} onTrack={onTrack} />
                            )}
                            
                            {mode === 'guided_code' && (
                                <CodeEntryQuestion question={question} onAnswer={onAnswer} onTrack={onTrack} guided={true} />
                            )}
                            
                            {mode === 'free_code' && (
                                <CodeEntryQuestion question={question} onAnswer={onAnswer} onTrack={onTrack} guided={false} />
                            )}
                        </div>
                    </div>
                </div>
            );
        };
        
        const CompletionModal = ({ code, onClose }) => {
            const [copied, setCopied] = useState(false);
            
            const copyCode = () => {
                navigator.clipboard.writeText(code);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl max-w-md w-full p-8 fade-in">
                        <div className="text-center mb-6">
                            <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg className="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <h3 className="text-2xl font-bold text-gray-900">Congratulations! 🎉</h3>
                            <p className="mt-2 text-gray-600">
                                You've achieved 90% mastery of pandas operations!
                            </p>
                        </div>
                        
                        <div className="bg-gray-50 rounded-lg p-4 mb-6">
                            <p className="text-sm font-medium text-gray-700 mb-2">Your completion code:</p>
                            <div className="flex items-center space-x-2">
                                <code className="flex-1 bg-white px-3 py-2 rounded border border-gray-300 text-sm">
                                    {code}
                                </code>
                                <button
                                    onClick={copyCode}
                                    className="px-3 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors"
                                >
                                    {copied ? 'Copied!' : 'Copy'}
                                </button>
                            </div>
                        </div>
                        
                        <button
                            onClick={onClose}
                            className="w-full py-3 px-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-medium rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all"
                        >
                            Continue Learning
                        </button>
                    </div>
                </div>
            );
        };
        
        const App = () => {
            const [questions, setQuestions] = useState([]);
            const [currentQuestion, setCurrentQuestion] = useState(null);
            const [progress, setProgress] = useState({ total: 0, mastered: 0 });
            const [questionMode, setQuestionMode] = useState('multiple_choice');
            const [showCompletion, setShowCompletion] = useState(false);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [performanceHistory, setPerformanceHistory] = useState([]);
            const [trackingData, setTrackingData] = useState([]);
            const [sessionId] = useState(() => `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`);
            const [performanceStreak, setPerformanceStreak] = useState(0);
            
            const srs = useMemo(() => new SRSAlgorithm(), []);
            
            // Load questions and progress
            useEffect(() => {
                const loadData = async () => {
                    try {
                        const response = await fetch('./questions.json');
                        if (!response.ok) throw new Error(`Failed to load questions: ${response.status} ${response.statusText}`);
                        
                        const data = await response.json();
                        console.log('Loaded questions:', data);
                        
                        // Load saved progress
                        const savedProgress = localStorage.getItem('pandasMasteryProgress');
                        const progressData = savedProgress ? JSON.parse(savedProgress) : {};
                        
                        // Load performance history
                        const savedHistory = localStorage.getItem('pandasMasteryHistory');
                        const historyData = savedHistory ? JSON.parse(savedHistory) : [];
                        setPerformanceHistory(historyData);
                        
                        // Load tracking data
                        const savedTracking = localStorage.getItem('pandasMasteryTracking');
                        const trackingDataParsed = savedTracking ? JSON.parse(savedTracking) : [];
                        setTrackingData(trackingDataParsed);
                        
                        // Initialize questions with SRS data
                        const questionsWithSRS = data.questions.map(q => ({
                            ...q,
                            srs: progressData[q.id] || {
                                repetitions: 0,
                                easiness: 2.5,
                                interval: 0,
                                nextReview: Date.now()
                            }
                        }));
                        
                        console.log('Questions with SRS:', questionsWithSRS);
                        setQuestions(questionsWithSRS);
                        updateProgress(questionsWithSRS);
                        setLoading(false);
                    } catch (err) {
                        console.error('Error loading data:', err);
                        setError(err.message);
                        setLoading(false);
                    }
                };
                
                loadData();
            }, []);
            
            // Select next question
            useEffect(() => {
                if (questions.length === 0 || currentQuestion !== null) return;
                
                // Calculate recent performance
                const getRecentPerformance = (n) => {
                    const recent = performanceHistory.slice(-n);
                    if (recent.length === 0) return 1.0;
                    return recent.filter(h => h.correct).length / recent.length;
                };
                
                const perf5 = getRecentPerformance(5);
                const perf10 = getRecentPerformance(10);
                const avgPerf = (perf5 + perf10) / 2;
                
                // Determine maximum difficulty based on performance
                let maxDifficulty = 3;
                if (avgPerf < 0.4) {
                    maxDifficulty = 1; // Only easy questions
                } else if (avgPerf < 0.7) {
                    maxDifficulty = 2; // Easy and medium questions
                }
                
                // Filter questions by difficulty and due date
                const dueQuestions = questions.filter(q => 
                    q.srs.nextReview <= Date.now() && 
                    q.difficulty <= maxDifficulty
                );
                
                let selectedQuestion;
                if (dueQuestions.length === 0) {
                    // No due questions at appropriate difficulty
                    const appropriateQuestions = questions.filter(q => q.difficulty <= maxDifficulty);
                    const sorted = [...appropriateQuestions].sort((a, b) => a.srs.nextReview - b.srs.nextReview);
                    selectedQuestion = sorted[0];
                } else {
                    // Pick a random due question
                    const randomIndex = Math.floor(Math.random() * dueQuestions.length);
                    selectedQuestion = dueQuestions[randomIndex];
                }
                
                setCurrentQuestion(selectedQuestion);
                
                // Determine mode based on progress
                const masteredCount = questions.filter(q => q.srs.repetitions >= 3).length;
                const ratio = masteredCount / questions.length;
                
                if (ratio < 0.3) {
                    setQuestionMode('multiple_choice');
                } else if (ratio < 0.6) {
                    setQuestionMode('guided_code');
                } else {
                    setQuestionMode('free_code');
                }
            }, [questions, currentQuestion, performanceHistory]);
            
            const updateProgress = (questionList) => {
                const mastered = questionList.filter(q => q.srs && q.srs.repetitions >= 5).length;
                setProgress({ total: questionList.length, mastered });
                
                // Check for completion
                if (questionList.length > 0 && mastered / questionList.length >= 0.9) {
                    const existingCode = localStorage.getItem('pandasMasteryCompletionCode');
                    if (!existingCode) {
                        const code = `PANDAS-MASTER-${Date.now().toString(36).toUpperCase()}`;
                        localStorage.setItem('pandasMasteryCompletionCode', code);
                        setShowCompletion(true);
                    }
                }
            };
            
            const handleTrack = (trackData) => {
                if (!currentQuestion) return;
                
                // Calculate times seen and times correct for this question
                const previousAttempts = trackingData.filter(t => t.question_id === currentQuestion.id);
                const timesCorrect = previousAttempts.filter(t => t.is_correct).length + (trackData.is_correct ? 1 : 0);
                
                // Calculate performance streak
                let newStreak = performanceStreak;
                if (trackData.is_correct) {
                    newStreak = performanceStreak + 1;
                } else if (!trackData.skipped) {
                    newStreak = 0;
                }
                setPerformanceStreak(newStreak);
                
                const fullTrackData = {
                    ...trackData,
                    times_seen: previousAttempts.length + 1,
                    times_correct: timesCorrect,
                    timestamp: Date.now(),
                    difficulty: currentQuestion.difficulty,
                    performance_streak: newStreak,
                    session_id: sessionId,
                    dataset: currentQuestion.dataset
                };
                
                const newTrackingData = [...trackingData, fullTrackData];
                setTrackingData(newTrackingData);
                localStorage.setItem('pandasMasteryTracking', JSON.stringify(newTrackingData));
            };
            
            const handleAnswer = (quality) => {
                if (!currentQuestion) return;
                
                // Track performance
                const isCorrect = quality >= 4; // Quality 4-5 means correct
                const newHistory = [...performanceHistory, {
                    timestamp: Date.now(),
                    questionId: currentQuestion.id,
                    difficulty: currentQuestion.difficulty,
                    correct: isCorrect,
                    quality: quality
                }];
                setPerformanceHistory(newHistory);
                localStorage.setItem('pandasMasteryHistory', JSON.stringify(newHistory));
                
                // Update SRS data
                const newSRS = srs.calculateNextReview(
                    quality,
                    currentQuestion.srs.repetitions,
                    currentQuestion.srs.easiness,
                    currentQuestion.srs.interval
                );
                
                const updatedQuestions = questions.map(q =>
                    q.id === currentQuestion.id
                        ? { ...q, srs: newSRS }
                        : q
                );
                
                setQuestions(updatedQuestions);
                updateProgress(updatedQuestions);
                
                // Save progress
                const progressData = {};
                updatedQuestions.forEach(q => {
                    progressData[q.id] = q.srs;
                });
                localStorage.setItem('pandasMasteryProgress', JSON.stringify(progressData));
                
                // Move to next question
                setCurrentQuestion(null);
            };
            
            const handleExport = async () => {
                if (trackingData.length === 0) {
                    alert('No tracking data available to export.');
                    return;
                }
                
                try {
                    // Create CSV content
                    const headers = [
                        'question_id',
                        'question_text',
                        'answer_selected',
                        'correct_answer',
                        'is_correct',
                        'hint_shown',
                        'times_seen',
                        'times_correct',
                        'timestamp',
                        'difficulty',
                        'time_spent',
                        'question_type',
                        'skipped',
                        'performance_streak',
                        'session_id',
                        'dataset'
                    ];
                    
                    const csvRows = [headers.join(',')];
                    
                    trackingData.forEach(row => {
                        const values = headers.map(header => {
                            let value = row[header];
                            
                            // Handle special cases
                            if (value === null || value === undefined) {
                                value = '';
                            } else if (typeof value === 'string' && value.includes(',')) {
                                // Escape commas in strings
                                value = `"${value.replace(/"/g, '""')}"`;
                            } else if (typeof value === 'boolean') {
                                value = value ? 'TRUE' : 'FALSE';
                            } else if (header === 'timestamp') {
                                // Convert timestamp to readable date
                                value = new Date(value).toISOString();
                            }
                            
                            return value;
                        });
                        
                        csvRows.push(values.join(','));
                    });
                    
                    const csvContent = csvRows.join('\n');
                    
                    // Create zip file
                    const zip = new JSZip();
                    zip.file('tracking_data.csv', csvContent);
                    
                    // Generate zip file
                    const blob = await zip.generateAsync({ type: 'blob' });
                    
                    // Create download
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    const dateStr = new Date().toISOString().split('T')[0];
                    a.href = url;
                    a.download = `pandas_progress_${dateStr}.results`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                } catch (error) {
                    console.error('Export failed:', error);
                    alert('Failed to export results. Please try again.');
                }
            };
            
            const resetProgress = () => {
                if (confirm('Are you sure you want to reset all progress?')) {
                    localStorage.removeItem('pandasMasteryProgress');
                    localStorage.removeItem('pandasMasteryHistory');
                    localStorage.removeItem('pandasMasteryTracking');
                    localStorage.removeItem('pandasMasteryCompletionCode');
                    window.location.reload();
                }
            };
            
            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="w-16 h-16 border-4 border-purple-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                            <p className="text-gray-600">Loading questions...</p>
                        </div>
                    </div>
                );
            }
            
            if (error) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg className="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </div>
                            <p className="text-gray-900 font-medium">Failed to load questions</p>
                            <p className="text-gray-600 text-sm mt-1">{error}</p>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="min-h-screen bg-gray-50">
                    <Header 
                        progress={progress} 
                        performanceHistory={performanceHistory} 
                        onReset={resetProgress}
                        onExport={handleExport}
                    />
                    
                    <main className="py-12 px-4">
                        {currentQuestion ? (
                            <QuestionCard
                                question={currentQuestion}
                                mode={questionMode}
                                onAnswer={handleAnswer}
                                onTrack={handleTrack}
                            />
                        ) : (
                            <div className="text-center py-12">
                                <div className="shimmer h-96 max-w-4xl mx-auto rounded-xl"></div>
                            </div>
                        )}
                    </main>
                    
                    {showCompletion && (
                        <CompletionModal
                            code={localStorage.getItem('pandasMasteryCompletionCode')}
                            onClose={() => setShowCompletion(false)}
                        />
                    )}
                </div>
            );
        };
        
        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>